name: Build and publish release artifacts

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    env:
      ARTIFACTS_DIR: ${{ github.workspace }}/artifacts/${{ matrix.os }}
      VCPKG_DIR: ${{ github.workspace }}/.github/vcpkg

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node (for pnpm)
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Ensure artifacts dir
        run: |
          mkdir -p "${{ env.ARTIFACTS_DIR }}"

      - name: Validate VERSION vs tag (Linux)
        if: runner.os == 'Linux'
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          # Fetch origin/master and ensure the tag commit is contained in master
          git fetch origin master:refs/remotes/origin/master --depth=1 || true
          TAG_COMMIT=$(git rev-parse "$GITHUB_REF")
          if ! git merge-base --is-ancestor "$TAG_COMMIT" refs/remotes/origin/master; then
            echo "Tag commit ($TAG_COMMIT) is not contained in origin/master. Rejecting tag push."; exit 1
          fi

          VERSION_FILE=$(cat VERSION)
          if [ "${TAG#v}" != "$VERSION_FILE" ]; then
            echo "Tag ($TAG) does not match VERSION file ($VERSION_FILE)"; exit 1
          fi
          echo "VERSION=$VERSION_FILE" >> $GITHUB_ENV
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
        shell: bash

      - name: Validate VERSION vs tag (Windows)
        if: runner.os == 'Windows'
        run: |
          pwsh -NoProfile -Command {
            $tag = $env:GITHUB_REF -replace '^refs/tags/',''
            # Fetch origin/master
            git fetch origin master:refs/remotes/origin/master --depth=1
            $tagCommit = git rev-parse $env:GITHUB_REF
            $mergeCheck = git merge-base --is-ancestor $tagCommit refs/remotes/origin/master
            if ($LASTEXITCODE -ne 0) { Write-Error "Tag commit ($tagCommit) is not contained in origin/master. Rejecting tag push."; exit 1 }

            $version = (Get-Content -Path VERSION -Raw).Trim()
            if ($tag.TrimStart('v') -ne $version) { Write-Error "Tag ($tag) does not match VERSION ($version)"; exit 1 }
            Add-Content -Path $env:GITHUB_ENV -Value "VERSION=$version"
            Add-Content -Path $env:GITHUB_ENV -Value "RELEASE_TAG=$tag"
          }
        shell: pwsh

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.VCPKG_DIR }}/installed
            ${{ env.VCPKG_DIR }}/packages
            ${{ env.VCPKG_DIR }}/buildtrees
          key: vcpkg-${{ runner.os }}-v1

      - name: Bootstrap vcpkg
        run: |
          if [ ! -d "${{ env.VCPKG_DIR }}" ]; then git clone --depth 1 https://github.com/microsoft/vcpkg.git "${{ env.VCPKG_DIR }}"; fi
          if [ "${{ runner.os }}" = "Linux" ]; then "${{ env.VCPKG_DIR }}"/bootstrap-vcpkg.sh; else pwsh -NoProfile -Command "${{ env.VCPKG_DIR }}\bootstrap-vcpkg.bat"; fi
        shell: bash

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ~/.cache/pnpm
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies (app)
        run: |
          cd app
          pnpm install --frozen-lockfile
        shell: bash

      - name: Run frontend unit tests
        run: |
          cd app
          pnpm test --if-present
        shell: bash

      - name: Build and run engine unit tests (Linux)
        if: runner.os == 'Linux'
        run: |
          cmake -S engine -B engine/build-test -GNinja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_DIR }}/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DVCPKG_MANIFEST_MODE=ON \
            -DVAYU_BUILD_TESTS=ON \
            -DVAYU_BUILD_ENGINE=ON
          cmake --build engine/build-test -j $(nproc)
          ctest --test-dir engine/build-test --output-on-failure -j $(nproc)
        shell: bash

      - name: Build and run engine unit tests (Windows)
        if: runner.os == 'Windows'
        run: |
          pwsh -NoProfile -Command {
            $vcpkg = "${{ env.VCPKG_DIR }}"
            cmake -S engine -B engine/build-test -G "Visual Studio 17 2022" -A x64 `
              -DCMAKE_BUILD_TYPE=Release `
              -DCMAKE_TOOLCHAIN_FILE="$vcpkg\scripts\buildsystems\vcpkg.cmake" `
              -DVCPKG_TARGET_TRIPLET=x64-windows `
              -DVCPKG_MANIFEST_MODE=ON `
              -DVAYU_BUILD_TESTS=ON `
              -DVAYU_BUILD_ENGINE=ON
            cmake --build engine/build-test --config Release --parallel
            ctest --test-dir engine/build-test --output-on-failure
          }
        shell: pwsh

      - name: Run build script (Linux)
        if: runner.os == 'Linux'
        run: |
          chmod +x scripts/build/build-linux.sh
          scripts/build/build-linux.sh prod --vcpkg-root "${{ env.VCPKG_DIR }}" --artifacts "${{ env.ARTIFACTS_DIR }}"
        shell: bash

      - name: Run build script (Windows)
        if: runner.os == 'Windows'
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -Command "& { .\scripts\build\build-windows.ps1 -BuildMode prod -VcpkgRootParam '${{ env.VCPKG_DIR }}' -ArtifactsDirParam '${{ env.ARTIFACTS_DIR }}' }"
        shell: pwsh

      - name: List artifacts
        run: |
          echo "Artifacts for ${{ matrix.os }}:"
          ls -la "${{ env.ARTIFACTS_DIR }}" || true

      - name: Upload artifacts to Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ env.ARTIFACTS_DIR }}/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
